/*! sgf-core - v0.1.0 - 2013-09-08
* Copyright (c) 2013 ; Licensed  */
go.partial=function(a,b,c){return function(){for(var d=0,e=b.slice(0),f=0;f<e.length&&d<arguments.length;f++)void 0===e[f]&&(e[f]=arguments[d++]);return a.apply(c||this,e)}},go.sgfToXy=function(a){return a?[a.charCodeAt(0)-97,a.charCodeAt(1)-97]:[]},go.xyToSgf=function(a){return a?String.fromCharCode(a.x+97)+String.fromCharCode(a.y+97):""},go.warn=function(a){console&&console.warn&&console.warn(a)},go.Board=function(a){this.size=parseInt(a)||19,this.stones=null,this.annotations=null,this._events={},this.clearBoard(),this.clearAnnotations()},go.Board.prototype.addEventListener=function(a,b){var c=this._events[a]=this._events[a]||[];c.push(b)},go.Board.prototype.dispatchEvent=function(a,b){if(this._events.hasOwnProperty(a)){var c,d=this._events[a];for(c=0;c<d.length;c++)d[c].apply(this,b)}},go.Board.prototype.clearAnnotations=function(){this.annotations=new Array(this.size);for(var a=0;a<this.stones.length;a++)this.annotations[a]=new Array(this.size)},go.Board.prototype.clearBoard=function(){this.stones=new Array(this.size);for(var a=0;a<this.stones.length;a++)this.stones[a]=new Array(this.size)},go.Board.prototype.changed=function(){this.dispatchEvent("change")},go.Board.prototype.stoneAt=function(a,b){return this.stones[a][b]},go.Board.prototype.stoneAtSgf=function(a){var b=go.sgfToXy(a);return this.stoneAt(b[0],b[1])},go.Board.prototype.addStone=function(a,b,c,d){if(a<this.stones.length&&b<this.stones.length&&!this.stones[a][b]){var e=new go.Stone(a,b,this,c);this.stones[a][b]=e,e.mergeGroup(),e.killNeighbors()}d||this.changed()},go.Board.prototype.addStoneBySgf=function(a,b,c){var d=go.sgfToXy(a);this.addStone(d[0],d[1],b,c)},go.Board.prototype.removeStone=function(a,b,c){var d=this.stones[a][b];d&&d.removeFromBoard(),c||this.changed()},go.Board.prototype.removeStoneBySgf=function(a,b){var c=go.sgfToXy(a);this.removeStone(c[0],c[1],b)},go.Board.prototype.serialize=function(){var a,b,c,d={w:[],b:[],size:this.size};for(b=0;b<this.stones.length;b++)for(c=0;c<this.stones.length;c++)a=this.stones[b][c],a&&d[a.color].push({x:b,y:c});return JSON.stringify(d)},go.Board.prototype.deserialize=function(a){"string"==typeof a&&(a=JSON.parse(a));var b=this;b.size=a.hasOwnProperty("size")?a.size:19,b.clearBoard(),a.hasOwnProperty("w")&&a.w.forEach(function(a){b.addStone(a.x,a.y,"w",!0)}),a.hasOwnProperty("b")&&a.b.forEach(function(a){b.addStone(a.x,a.y,"b",!0)}),this.changed()},go.Stone=function(a,b,c,d){this.x=a,this.y=b,this.board=c,this.color=d,this.group=null},go.Stone.prototype.neighbors=function(a,b){b=b||"map";var c=[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y-1},{x:this.x,y:this.y+1}],d=this.board,e=this;return c.filter(function(a){return a.x>=0&&a.y>=0&&a.x<d.stones.length&&a.y<d.stones.length})[b](function(b){return a.call(e,d.stones[b.x][b.y])})},go.Stone.prototype.rediscoverGroup=function(a){a||(a=new Group),this.group&&(this.group.stones=this.group.stones.filter(function(a){return a!=this})),this.group=a,this.group.stones.push(this);var b=function(b){b&&this.color==b.color&&this.group!=b.group&&b.rediscoverGroup(a)};this.neighbors(b)},go.Stone.prototype.mergeGroup=function(){var a=function(a){if(a&&a.color==this.color){var b=a.group;this.group&&b?b.setNewGroup(this.group):b?(this.group=b,b.stones.push(this)):this.group?(a.group=this.group,this.group.stones.push(a)):a.group=this.group=new go.Group([this,a])}};this.neighbors(a)},go.Stone.prototype.killNeighbors=function(){var a=function(a){if(a&&a.color!=this.color){var b=a.group||a;b.hasLiberty()||this.board.dispatchEvent("stones_killed",b.die())}};this.neighbors(a)},go.Stone.prototype.hasLiberty=function(){var a=function(a){return!a};return this.neighbors(a,"some")},go.Stone.prototype.die=function(){return this.removeFromBoard(),[[this]]},go.Stone.prototype.removeFromBoard=function(){this.board.stones[this.x][this.y]=null,this.group&&(this.group=null,this.neighbors(function(a){a&&this.color==a.color&&a.rediscoverGroup()}))},go.Group=function(a){a||(a=[]),this.stones=a;var b;for(b=0;b<a.length;b++)a[b].group=this},go.Group.prototype.setNewGroup=function(a){var b;if(this!=a){for(b=0;b<this.stones.length;b++)this.stones[b].group=a;a.stones=a.stones.concat(this.stones)}},go.Group.prototype.hasLiberty=function(){return this.stones.some(function(a){return a.hasLiberty()})},go.Group.prototype.die=function(){return this.stones.forEach(function(a){a.group=null,a.removeFromBoard()}),[this.stones]},go.SGF=function(){this.size=19,this.root_move=null,this.white_player="White",this.black_player="Black",this.handicap=0,this.ruleset="Japanese",this.komi=0},go.SGF.prototype.getBlankBoard=function(){return new go.Board(this.size)},go.Move=function(){this.sgf=null,this.position=null,this.color=null,this.previous_move=null,this.comment="",this.labels=[],this.triangles=[],this.circles=[],this.squares=[],this.x_marks=[],this._next_moves=[],this._static_white=[],this._static_black=[],this._static_empty=[],this._cached_serialized_board=null},go.Move.prototype.addNextMove=function(a){this._next_moves.push(a),a.previous_move=this},go.Move.prototype.getBoard=function(){var a;return this._cached_serialized_board?(a=this.sgf.getBlankBoard(),a.deserialize(this._cached_serialized_board),a):(a=this.previous_move?this.previous_move.getBoard():this.sgf.getBlankBoard(),this.applyToBoard(a),this._cached_serialized_board=a.serialize(),a)},go.Move.prototype.applyToBoard=function(a){var b=go.partial(a.removeStoneBySgf,[void 0,!0],a),c=go.partial(a.addStoneBySgf,[void 0,"b",!0],a),d=go.partial(a.addStoneBySgf,[void 0,"w",!0],a);this._static_empty.forEach(b),this._static_black.forEach(c),this._static_white.forEach(d),this.position&&a.addStoneBySgf(this.position,this.color,!0),a.changed()},go.tokenizeSgfData=function(a){for(var b,c="",d=[],e=!1,f=!1,g=/[\(\);]/,h=0,i=0,j=0;j<a.length;j++)if(b=a.charAt(j),e)f||"\\"!==b?(c+=b,f||"]"!==b||(e=!1,d.push(c),c=""),f=!1):f=!0;else if(b.match(g)||b.match(/\s/)){if(c&&(d.push(c),c=""),")"===b&&(i+=1),"("===b&&(h+=1),i>h)throw'Unmatched ")"!';b.trim()&&d.push(b)}else b.match(/\w/)?c+=b:"["===b&&(c+=b,e=!0);if(e||c||0!==h-i)throw"Invalid SGF data!";return d},go.parseMethodValue=function(a){var b=/^(\w*)\[(.*)\]$/,c=a.match(b);if(c&&3==c.length)return c.slice(1);throw'Broken token "'+a+'"!'},go.parseSgfData=function(a){for(var b,c,d,e,f,g,h=go.tokenizeSgfData(a),i=[],j=new go.SGF,k=0;k<h.length;k++)if(b=h[k],"("===b)c&&i.push(d);else if(")"===b)i.length>0&&(d=i.pop());else if(";"===b)c=d,d=new go.Move,d.sgf=j,null===j.root_move&&(j.root_move=d),c&&c.addNextMove(d);else if(g=go.parseMethodValue(b),e=g[0]||e,f=g[1],"B"===e||"W"===e)d.color=e.toLowerCase(),d.position=f;else if("C"===e)d.comment=f;else if("AB"===e)d._static_black.push(f);else if("AW"===e)d._static_white.push(f);else if("AE"===e)d._static_empty.push(f);else if("TR"===e)d.triangles.push(f);else if("SQ"===e)d.squares.push(f);else if("CR"===e)d.circles.push(f);else if("MA"===e)d.x_marks.push(f);else if("LB"===e)d.labels.push(f);else if("SZ"===e)j.size=parseInt(f);else if("FF"===e)"4"!==f&&go.warn("File format 4 explicitly supported - YMMV with other formats.");else if("GM"===e){if("1"!==f)throw"SGF type is not Go!"}else"ST"===e||"CA"===e||("RU"===e?j.ruleset=f:"PW"===e?j.white_player=f:"PB"===e?j.black_player=f:"HA"===e?j.handicap=f:"KM"===e?j.komi=f:"TM"===e||"OT"===e||"RE"===e||"GN"===e||"BT"===e||"WT"===e||"BR"===e||"WR"===e||"AN"===e||"AP"===e||"CP"===e||"EV"===e||"DT"===e||go.warn('Warning: Unrecognized method "'+e+'"!'));return j};